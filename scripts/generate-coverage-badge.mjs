/**
 * Generate a coverage badge from vitest coverage summary.
 *
 * This script reads the coverage/coverage-summary.json file generated by
 * vitest and creates a shields.io-compatible badge JSON file that can be
 * committed to the repository.
 *
 * Usage: node scripts/generate-coverage-badge.mjs
 */

import { readFileSync, writeFileSync, mkdirSync } from 'fs'
import { dirname, join } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const projectRoot = join(__dirname, '..')

function getColor(percentage) {
  if (percentage >= 80) return 'brightgreen'
  if (percentage >= 70) return 'green'
  if (percentage >= 60) return 'yellow'
  if (percentage >= 50) return 'orange'
  return 'red'
}

function formatPercentage(value) {
  return Math.round(value * 100) / 100
}

try {
  // Read the coverage summary
  const summaryPath = join(projectRoot, 'coverage', 'coverage-summary.json')
  const summary = JSON.parse(readFileSync(summaryPath, 'utf8'))

  // Extract total coverage
  const total = summary.total
  const statements = total.statements.pct
  const branches = total.branches.pct
  const functions = total.functions.pct
  const lines = total.lines.pct

  // Calculate average coverage (weighted towards statements and lines)
  const avgCoverage = (statements + lines + functions + branches) / 4
  const percentage = formatPercentage(avgCoverage)

  // Create badge data (shields.io endpoint JSON format)
  const badgeData = {
    schemaVersion: 1,
    label: 'coverage',
    message: `${percentage}%`,
    color: getColor(percentage)
  }

  // Ensure .badges directory exists
  const badgesDir = join(projectRoot, '.badges')
  mkdirSync(badgesDir, { recursive: true })

  // Write badge JSON
  const badgePath = join(badgesDir, 'coverage.json')
  writeFileSync(badgePath, JSON.stringify(badgeData, null, 2) + '\n')

  console.log(`âœ“ Coverage badge generated: ${percentage}%`)
  console.log(`  Statements: ${formatPercentage(statements)}%`)
  console.log(`  Branches:   ${formatPercentage(branches)}%`)
  console.log(`  Functions:  ${formatPercentage(functions)}%`)
  console.log(`  Lines:      ${formatPercentage(lines)}%`)
  console.log(`  Badge written to: ${badgePath}`)

  process.exit(0)
} catch (error) {
  console.error('Error generating coverage badge:', error.message)
  console.error('\nMake sure to run "npm run test:cov" first to generate coverage data.')
  process.exit(1)
}
